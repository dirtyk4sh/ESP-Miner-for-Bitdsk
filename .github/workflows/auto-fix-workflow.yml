name: Auto-Fix Compilation Errors

on:
  workflow_dispatch:  # Manual trigger from GitHub UI

jobs:
  fix-errors:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Search for error patterns
      run: |
        echo "=== Searching for compilation errors ==="
        echo ""
        
        echo "=== construct_bm_job errors ==="
        grep -rn "construct_bm_job.*extranonce_2_str" --include="*.c" . || echo "Not found"
        
        echo ""
        echo "=== STRATUM_V1_subscribe errors ==="
        grep -rn "STRATUM_V1_subscribe.*extranonce1" --include="*.c" . || echo "Not found"
        
        echo ""
        echo "=== should_abandon_work errors ==="
        grep -rn "should_abandon_work" --include="*.c" . || echo "Not found"
        
        echo ""
        echo "=== BM1366_FULLSCAN_MS errors ==="
        grep -rn "BM1366_FULLSCAN_MS" --include="*.c" . || echo "Not found"
        
        echo ""
        echo "=== WIFI_MAXIMUM_RETRY errors ==="
        grep -rn "WIFI_MAXIMUM_RETRY" --include="*.c" . || echo "Not found"
        
        echo ""
        echo "=== wifi_init errors ==="
        grep -rn "wifi_init.*," --include="*.c" . | grep -v "//" || echo "Not found"
    
    - name: Apply fixes
      run: |
        echo "=== Applying fixes ==="
        
        # Fix 1: construct_bm_job - remove extranonce_2_str argument
        find . -name "*.c" -type f -exec sed -i 's/construct_bm_job(\([^,]*\), \([^,]*\), \([^,]*\), extranonce_2_str)/construct_bm_job(\1, \2, \3)/g' {} +
        
        # Fix 2: STRATUM_V1_subscribe - simplify arguments
        find . -name "*.c" -type f -exec sed -i 's/STRATUM_V1_subscribe(GLOBAL_STATE->sock, &GLOBAL_STATE->extranonce1, &GLOBAL_STATE->extranonce2_size,$/STRATUM_V1_subscribe(GLOBAL_STATE->sock,/g' {} +
        
        # Fix 3: should_abandon_work -> clean_jobs
        find . -name "*.c" -type f -exec sed -i 's/notify->should_abandon_work/notify->clean_jobs/g' {} +
        
        # Fix 4: BM1366_FULLSCAN_MS -> ASIC_SCAN_INTERVAL_MS
        find . -name "*.c" -type f -exec sed -i 's/BM1366_FULLSCAN_MS/ASIC_SCAN_INTERVAL_MS/g' {} +
        
        # Fix 5: WIFI_MAXIMUM_RETRY -> CONFIG_ESP_MAXIMUM_RETRY
        find . -name "*.c" -type f -exec sed -i 's/WIFI_MAXIMUM_RETRY/CONFIG_ESP_MAXIMUM_RETRY/g' {} +
        
        # Fix 6: wifi_init with trailing comma
        find . -name "*.c" -type f -exec sed -i 's/wifi_init(\([^,]*\), \([^,]*\), \([^)]*\),$/wifi_init(\1, \2, \3);/g' {} +
        
        echo "=== Fixes applied ==="
    
    - name: Verify fixes
      run: |
        echo "=== Verifying fixes ==="
        
        ! grep -rn "construct_bm_job.*extranonce_2_str" --include="*.c" . && echo "✓ construct_bm_job fixed"
        ! grep -rn "should_abandon_work" --include="*.c" . && echo "✓ should_abandon_work fixed"
        ! grep -rn "BM1366_FULLSCAN_MS" --include="*.c" . && echo "✓ BM1366_FULLSCAN_MS fixed"
        ! grep -rn "WIFI_MAXIMUM_RETRY" --include="*.c" . && echo "✓ WIFI_MAXIMUM_RETRY fixed"
        
        echo "All fixes verified!"
    
    - name: Commit and push
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        git add -A
        
        if ! git diff --cached --quiet; then
          git commit -m "fix: resolve compilation errors in BitDsk firmware

- Remove extra argument from construct_bm_job()
- Fix STRATUM_V1_subscribe() function signature
- Change should_abandon_work to clean_jobs
- Replace BM1366_FULLSCAN_MS with ASIC_SCAN_INTERVAL_MS
- Replace WIFI_MAXIMUM_RETRY with CONFIG_ESP_MAXIMUM_RETRY
- Fix wifi_init() argument list"
          
          git push origin main
          echo "✓ Fixes committed and pushed!"
        else
          echo "✓ No changes to commit"
        fi
