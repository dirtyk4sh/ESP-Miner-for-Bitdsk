name: Build - Show Errors

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: espressif/idf:v5.1
      options: -u root
      
    steps:
    - uses: actions/checkout@v4

    - name: Setup
      run: |
        . $IDF_PATH/export.sh
        idf.py --version

    - name: Set target
      run: |
        . $IDF_PATH/export.sh
        idf.py set-target esp32s3

    - name: Build with full output
      run: |
        . $IDF_PATH/export.sh
        echo "===== STARTING BUILD ====="
        idf.py build 2>&1 | tee build.log
        echo "===== BUILD COMPLETE ====="
        exit ${PIPESTATUS[0]}

    - name: Show last 300 lines
      if: always()
      run: |
        echo "===== LAST 300 LINES OF BUILD OUTPUT ====="
        tail -300 build.log

    - name: Find error lines
      if: always()
      run: |
        echo "===== LINES CONTAINING 'error' ====="
        grep -i error build.log || echo "No error lines found"
        echo ""
        echo "===== LINES CONTAINING 'undefined' ====="
        grep -i undefined build.log || echo "No undefined lines found"
