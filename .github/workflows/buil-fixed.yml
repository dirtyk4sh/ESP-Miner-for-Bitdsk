name: Build BitDsk ESP-Miner - Node.js 20 + Firmware

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: espressif/idf:v5.1
      options: -u root
      
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Node.js 20 (for Angular 17 AxeOS)
      run: |
        apt-get update
        apt-get install -y curl
        echo "Installing Node.js 20..."
        curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
        apt-get install -y nodejs
        echo "✓ Node.js installed"
        node --version
        npm --version

    - name: Setup ESP-IDF
      run: |
        . $IDF_PATH/export.sh
        idf.py --version

    - name: Build Web UI (AxeOS)
      run: |
        echo "===== Building Web UI (AxeOS) ====="
        cd main/http_server/axe-os
        npm install
        npm run build
        echo "===== Web UI Build Complete ====="
        cd ../../..

    - name: Verify web UI output
      run: |
        echo "===== Checking for web UI files ====="
        if [ -d main/http_server/axe-os/dist/axe-os ]; then
          echo "✓ Web UI built successfully"
          echo "Contents of dist/axe-os:"
          ls -la main/http_server/axe-os/dist/axe-os/ | head -20
        else
          echo "✗ Web UI build failed - dist folder not found"
          exit 1
        fi

    - name: Set ESP32-S3 target
      run: |
        . $IDF_PATH/export.sh
        idf.py set-target esp32s3

    - name: Build Firmware
      run: |
        . $IDF_PATH/export.sh
        echo "===== Building Firmware ====="
        idf.py build
        echo "===== Firmware Build Complete ====="

    - name: Merge Binaries
      run: |
        chmod +x merge_bin.sh
        echo "===== Merging Binaries ====="
        ./merge_bin.sh ./esp-miner-merged.bin
        if [ -f esp-miner-merged.bin ]; then
          ls -lh esp-miner-merged.bin
          echo "✓ Firmware merged successfully!"
        else
          echo "✗ Merge failed"
          exit 1
        fi

    - name: Upload Firmware Artifact
      uses: actions/upload-artifact@v4
      with:
        name: BitDsk-ESP-Miner-Firmware
        path: esp-miner-merged.bin
        retention-days: 90
