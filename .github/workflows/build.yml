name: Build BitDsk Firmware - Fixed

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: espressif/idf:v5.1
      options: -u root
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup environment
      run: |
        echo "=== Setting up ESP-IDF environment ==="
        echo "IDF_PATH: $IDF_PATH"
        echo "PATH: $PATH"
        . $IDF_PATH/export.sh
        echo "After export:"
        which idf.py
        idf.py --version
        echo "✓ Environment ready"

    - name: Show project structure
      run: |
        echo "=== Current directory ==="
        pwd
        echo ""
        echo "=== Repository files ==="
        ls -la
        echo ""
        echo "=== Checking required files ==="
        for file in CMakeLists.txt main/Kconfig.projbuild merge_bin.sh; do
          if [ -f "$file" ]; then
            echo "✓ $file"
          else
            echo "✗ MISSING: $file"
          fi
        done

    - name: Configure build
      run: |
        . $IDF_PATH/export.sh
        echo "=== Configuring for ESP32-S3 ==="
        idf.py set-target esp32s3
        echo "✓ Target set"

    - name: Build firmware
      run: |
        . $IDF_PATH/export.sh
        echo "=== Building firmware ==="
        idf.py build -v 2>&1 | tail -100
        BUILD_EXIT=$?
        echo ""
        echo "Build exit code: $BUILD_EXIT"
        exit $BUILD_EXIT

    - name: List build outputs
      if: always()
      run: |
        . $IDF_PATH/export.sh
        echo "=== Build artifacts ==="
        find build -name "*.bin" -exec ls -lh {} \; 2>/dev/null || echo "No .bin files found"
        echo ""
        echo "=== Build directory size ==="
        du -sh build 2>/dev/null || echo "build/ not found"

    - name: Merge binaries
      if: success()
      run: |
        . $IDF_PATH/export.sh
        echo "=== Preparing merge ==="
        chmod +x merge_bin.sh
        echo ""
        echo "=== Running merge_bin.sh ==="
        bash -x ./merge_bin.sh ./esp-miner-merged.bin
        MERGE_EXIT=$?
        echo ""
        echo "Merge exit code: $MERGE_EXIT"
        echo ""
        if [ -f esp-miner-merged.bin ]; then
          ls -lh esp-miner-merged.bin
          file esp-miner-merged.bin
          echo "✓ Firmware merged successfully!"
          exit 0
        else
          echo "✗ Merge failed - no output file created"
          exit 1
        fi

    - name: Upload artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: BitDsk-Firmware
        path: esp-miner-merged.bin
        retention-days: 90

    - name: Debug on failure
      if: failure()
      run: |
        . $IDF_PATH/export.sh
        echo "=== Debugging failed build ==="
        echo ""
        echo "=== ESP-IDF information ==="
        idf.py --version
        which idf.py
        echo ""
        echo "=== Last 50 lines of CMakeError log ==="
        [ -f build/CMakeFiles/CMakeError.log ] && tail -50 build/CMakeFiles/CMakeError.log || echo "No error log"
        echo ""
        echo "=== All .bin files in system ==="
        find build -name "*.bin" 2>/dev/null || echo "None found"
        find . -name "merge_bin.sh" 2>/dev/null || echo "merge_bin.sh not found"
