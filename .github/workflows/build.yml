name: Build BitDsk - Debug Output

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: espressif/idf:v5.1
      options: -u root
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup ESP-IDF
      run: |
        . $IDF_PATH/export.sh
        idf.py --version
        which idf.py

    - name: Check files
      run: |
        echo "=== Files ==="
        ls -la
        echo ""
        test -f CMakeLists.txt && echo "✓ CMakeLists.txt" || echo "✗ CMakeLists.txt MISSING"
        test -d main && echo "✓ main/" || echo "✗ main/ MISSING"
        test -f merge_bin.sh && echo "✓ merge_bin.sh" || echo "✗ merge_bin.sh MISSING"

    - name: Set target
      run: |
        . $IDF_PATH/export.sh
        idf.py set-target esp32s3

    - name: Build - Full Output
      run: |
        . $IDF_PATH/export.sh
        echo "=== FULL BUILD OUTPUT ==="
        idf.py build -v 2>&1 | tee build_output.log
        exit ${PIPESTATUS[0]}

    - name: Show build results
      if: always()
      run: |
        echo "=== Last 200 lines of build output ==="
        tail -200 build_output.log
        echo ""
        echo "=== Checking for .bin files ==="
        find build -name "*.bin" -exec ls -lh {} \;

    - name: Merge if build succeeded
      if: success()
      run: |
        . $IDF_PATH/export.sh
        chmod +x merge_bin.sh
        echo "=== Running merge_bin.sh ==="
        bash ./merge_bin.sh ./esp-miner-merged.bin
        if [ -f esp-miner-merged.bin ]; then
          ls -lh esp-miner-merged.bin
          echo "✓ SUCCESS"
        else
          echo "✗ Merge failed"
          exit 1
        fi

    - name: Upload firmware
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: BitDsk-Firmware
        path: esp-miner-merged.bin
        retention-days: 90

    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-output-log
        path: build_output.log
        retention-days: 7
