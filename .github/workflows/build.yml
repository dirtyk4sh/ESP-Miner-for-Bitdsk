name: Build BitDsk ESP-Miner

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: espressif/idf:v5.1
      options: -u root
      
    steps:
    - uses: actions/checkout@v4

    - name: Setup ESP-IDF
      run: |
        . $IDF_PATH/export.sh
        idf.py --version

    - name: Check files
      run: |
        echo "Checking repository..."
        [ -f CMakeLists.txt ] && echo "✓ CMakeLists.txt" || { echo "✗ Missing CMakeLists.txt"; exit 1; }
        [ -f merge_bin.sh ] && echo "✓ merge_bin.sh" || { echo "✗ Missing merge_bin.sh"; exit 1; }

    - name: Set target
      run: |
        . $IDF_PATH/export.sh
        idf.py set-target esp32s3

    - name: Build firmware
      run: |
        . $IDF_PATH/export.sh
        echo "Building..."
        idf.py build
        echo "Build complete!"

    - name: Merge binaries
      run: |
        chmod +x merge_bin.sh
        echo "Merging binaries..."
        ./merge_bin.sh ./esp-miner-merged.bin
        if [ -f esp-miner-merged.bin ]; then
          ls -lh esp-miner-merged.bin
          echo "✓ Firmware ready!"
        else
          echo "✗ Merge failed"
          exit 1
        fi

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: BitDsk-Firmware
        path: esp-miner-merged.bin
        retention-days: 90
