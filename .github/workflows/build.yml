name: Build BitDsk ESP-Miner - Simple

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up ESP-IDF
      uses: espressif/esp-idf-ci-action@e47ee90
      with:
        esp_idf_version: v5.1
        target: esp32s3

    - name: Show environment
      run: |
        echo "=== Environment ==="
        pwd
        echo "User: $(whoami)"
        echo "PATH: $PATH"
        echo ""
        echo "=== IDF Setup ==="
        . $IDF_PATH/export.sh
        idf.py --version
        echo ""
        echo "=== Project files ==="
        ls -la
        echo ""
        echo "=== Check CMakeLists.txt ==="
        [ -f CMakeLists.txt ] && echo "✓ CMakeLists.txt found" || echo "✗ CMakeLists.txt NOT found - THIS IS THE PROBLEM"
        echo ""
        echo "=== Check main directory ==="
        [ -d main ] && ls -la main/ || echo "main/ directory NOT found"
        echo ""
        echo "=== Check merge_bin.sh ==="
        [ -f merge_bin.sh ] && echo "✓ merge_bin.sh found" || echo "✗ merge_bin.sh NOT found"

    - name: Build ESP-Miner
      run: |
        . $IDF_PATH/export.sh
        idf.py build -v 2>&1 | tee build.log
        echo "Build exit code: $?"

    - name: Check build outputs
      if: always()
      run: |
        echo "=== Looking for build artifacts ==="
        find build -name "*.bin" -ls 2>/dev/null || echo "No .bin files in build/"
        echo ""
        echo "=== Build directory contents ==="
        ls -lh build/ 2>/dev/null || echo "build/ not accessible"
        echo ""
        echo "=== Check last 100 lines of build log ==="
        if [ -f build.log ]; then
          tail -100 build.log
        else
          echo "No build.log found"
        fi

    - name: Merge binaries
      if: success()
      run: |
        . $IDF_PATH/export.sh
        chmod +x merge_bin.sh
        echo "=== Running merge_bin.sh ==="
        ./merge_bin.sh ./esp-miner-merged.bin
        echo "Merge script exit code: $?"
        echo ""
        echo "=== Checking output ==="
        if [ -f esp-miner-merged.bin ]; then
          ls -lh esp-miner-merged.bin
          file esp-miner-merged.bin
          echo "✓ SUCCESS: esp-miner-merged.bin created!"
        else
          echo "✗ FAIL: esp-miner-merged.bin NOT created"
          ls -la *.bin 2>/dev/null || echo "No .bin files at all"
        fi

    - name: Upload firmware
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: BitDsk-ESP-Miner-Firmware
        path: esp-miner-merged.bin
        retention-days: 90

    - name: Upload build log (for debugging)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build.log
        retention-days: 7
